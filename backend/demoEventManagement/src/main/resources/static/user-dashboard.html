<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard</title>
    <style>
        body {font-family: Arial, sans-serif; background:#f8f9fa; padding:20px;}
        h2 {text-align:center;}
        .event-list, .tickets {margin:20px auto; width:80%; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
        button {padding:8px 15px; margin:5px; border:none; border-radius:6px; cursor:pointer;}
        .book {background:#007bff; color:#fff;}
        .delete {background:#dc3545; color:#fff;}
        .attendance {background:#28a745; color:#fff;}
    </style>
</head>
<body>
<h2>User Dashboard</h2>

<div class="event-list">
    <h3>Available Events</h3>
    <div id="events"></div>
</div>

<div class="tickets">
    <h3>My Tickets</h3>
    <div id="tickets"></div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('email');

    async function fetchEvents() {
        const res = await fetch("http://localhost:8081/events");
        const events = await res.json();
        const container = document.getElementById("events");
        container.innerHTML = "";
        events.forEach(ev => {
            container.innerHTML += `<p><b>${ev.eventName}</b> - ${ev.location} - ${ev.eventDate}
              <button class="book" onclick="bookTicket(${ev.id})">Book</button></p>`;
        });
    }

    async function bookTicket(eventId) {
        await fetch("http://localhost:8081/tickets/book", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({eventId, userEmail})
        });
        fetchTickets();
    }

    async function fetchTickets() {
        const res = await fetch(`http://localhost:8081/tickets/mine?email=${userEmail}`);
        const tickets = await res.json();
        const container = document.getElementById("tickets");
        container.innerHTML = "";
        tickets.forEach(t => {
            container.innerHTML += `<p>TicketID: ${t.id}, Event: ${t.event.eventName}, Date: ${t.event.eventDate}
              <button class="delete" onclick="deleteTicket(${t.id})">Cancel</button>
              <button class="attendance" onclick="markAttendance(${t.event.id})">Mark Attendance</button></p>`;
        });
    }

    async function deleteTicket(ticketId) {
        await fetch(`http://localhost:8081/tickets/${ticketId}`, {method:"DELETE"});
        fetchTickets();
    }

    async function markAttendance(eventId) {
        await fetch("http://localhost:8081/attendance/mark", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({userEmail, eventId})
        });
        alert("Attendance marked!");
    }

    fetchEvents();
    fetchTickets();
</script>
</body>
</html>
